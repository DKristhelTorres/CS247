<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play&Boom - Game Board</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            background: #000;
            color: #fff;
            margin: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cinematic {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            z-index: 10;
        }
        .cinematic-text {
            font-size: 2.2rem;
            text-align: center;
            max-width: 700px;
            opacity: 0;
            transition: opacity 0.8s;
            letter-spacing: 1px;
            line-height: 1.4;
            color: #fff;
        }
        .cinematic-text.active {
            opacity: 1;
        }
        .game-board {
            display: none;
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        .game-board.active {
            display: block;
        }
        .player-list-vertical {
            position: absolute;
            top: 0;
            left: 0;
            width: 220px;
            height: 100vh;
            background: rgba(30,30,30,0.95);
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 32px 0 32px 0;
            z-index: 2;
        }
        .player-card-vertical {
            background: #34495e;
            margin: 12px 16px;
            padding: 18px 10px;
            border-radius: 8px;
            color: #fff;
            text-align: left;
            min-width: 160px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .player-card-vertical.host {
            border: 2px solid #e74c3c;
        }
        .player-card-vertical .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #222;
        }
        .grid-area {
            position: absolute;
            left: 240px;
            top: 0;
            width: 520px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
        }
        .game-status {
            margin-bottom: 24px;
            color: #fff;
            font-size: 1.3rem;
        }
        .game-area {
            background: #223;
            border-radius: 12px;
            min-width: 400px;
            min-height: 320px;
            color: #fff;
            padding: 32px;
            font-size: 1.5rem;
        }
        .main-board-area {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 32px;
            margin: auto;
        }
        #board-grid {
            display: grid;
            grid-template-columns: repeat(7, 40px);
            grid-template-rows: repeat(7, 40px);
            gap: 4px;
            background: #bbb;
            padding: 12px;
            border-radius: 8px;
        }
        .grid-cell {
            width: 40px;
            height: 40px;
            background: #eee;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            position: relative;
        }
        .grid-cell.center {
            background: #3af !important;
        }
        .grid-cell.corner {
            background: #eee !important;
            border: 2px solid #888;
        }
        .grid-cell .token {
            font-size: 1.5rem;
            color: #1a237e;
        }
        #token-tray {
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: #bbb;
            padding: 16px;
            border-radius: 8px;
            min-width: 60px;
        }
        .token-piece {
            width: 40px;
            height: 40px;
            background: #fff;
            border: 2px solid #333;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            transition: background 0.2s, border 0.2s;
        }
        .token-piece.selected {
            background: #3af;
            border: 2px solid #1a237e;
        }
    </style>
</head>
<body>
    <div class="cinematic">
        <div id="cinematic-text" class="cinematic-text"></div>
    </div>
    <div class="game-board">
        <div class="player-list-vertical" id="player-list-vertical"></div>
        <div class="main-board-area">
            <div id="board-grid"></div>
            <div id="token-tray"></div>
        </div>
    </div>
    <script>
        // Cinematic narrative lines
        const narrative = [
            "You are a chaotic and rather unbothered government spy. You are what they call...",
            "A PIGEON",
            "In your journey of making abstract nests, you had enough of fighting for crumbs in these New York streets.",
            "Your job? Trigger in your fellow 'pigeon' mates a segfault in their surveillance system to get rid of the competition."
        ];
        const cinematicDiv = document.querySelector('.cinematic');
        const cinematicText = document.getElementById('cinematic-text');
        const gameBoard = document.querySelector('.game-board');
        const playerListVertical = document.getElementById('player-list-vertical');
        const gameStatus = document.getElementById('game-status');
        const gameArea = document.getElementById('game-area');

        // Multiplayer 7x7 board game logic
        const SERVER_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000'
            : 'https://cs247.onrender.com';
        const socket = io(SERVER_URL);

        const N = 7;
        let board = Array.from({length: N}, () => Array(N).fill(null));
        let players = [];
        let currentPlayerIdx = 0;
        let myPlayerIdx = null;
        let myRoomId = localStorage.getItem('roomPassword');
        let selectedToken = null;

        const tokenTypes = [
            { type: 'corner', symbol: '└' },
            { type: 'corner', symbol: '┘' },
            { type: 'corner', symbol: '┐' },
            { type: 'corner', symbol: '┌' },
            { type: 'straight', symbol: '│' },
            { type: 'straight', symbol: '─' },
            { type: 'cross', symbol: '┼' }
        ];

        // Show cinematic sequence
        let idx = 0;
        function showCinematicLine(i) {
            cinematicText.classList.remove('active');
            setTimeout(() => {
                cinematicText.textContent = narrative[i];
                cinematicText.classList.add('active');
            }, 400);
        }
        function nextCinematic() {
            if (idx < narrative.length) {
                showCinematicLine(idx);
                idx++;
                setTimeout(() => {
                    cinematicText.classList.remove('active');
                    setTimeout(nextCinematic, 1300); // fade out before next
                }, 4500); // show each line for 4.5s
            } else {
                cinematicDiv.style.display = 'none';
                document.querySelector('.game-board').classList.add('active');
                renderPlayerCardsVertical();
                renderBoard();
                renderTokenTray();
            }
        }

        // Render player cards vertically on the left
        function renderPlayerCardsVertical() {
            const playerListVertical = document.getElementById('player-list-vertical');
            playerListVertical.innerHTML = '';
            players.forEach((player, idx) => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card-vertical${player.alive ? '' : ' eliminated'}`;
                playerCard.innerHTML = `
                    <span class="color-dot" style="background:${player.color};"></span>
                    <div>
                        <div class="player-name">${player.name}${idx === currentPlayerIdx ? ' <b>(Turn)</b>' : ''}</div>
                        <div class="player-status">${player.alive ? 'Alive' : 'Eliminated'}</div>
                        <div class="player-tokens">Tokens: ${player.tokens}</div>
                    </div>
                `;
                playerListVertical.appendChild(playerCard);
            });
        }

        function renderBoard() {
            const boardGrid = document.getElementById('board-grid');
            boardGrid.innerHTML = '';
            for (let y = 0; y < N; y++) {
                for (let x = 0; x < N; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    // Corners
                    if ((x === 0 && y === 0) || (x === 0 && y === N-1) || (x === N-1 && y === 0) || (x === N-1 && y === N-1)) {
                        cell.classList.add('corner');
                        let cornerIdx = (x === 0 && y === 0) ? 0 :
                                        (x === 0 && y === N-1) ? 1 :
                                        (x === N-1 && y === N-1) ? 2 : 3;
                        cell.style.background = players[cornerIdx]?.color + '33';
                        cell.style.border = `2px solid ${players[cornerIdx]?.color}`;
                    }
                    // Center
                    if (x === Math.floor(N/2) && y === Math.floor(N/2)) {
                        cell.classList.add('center');
                    }
                    // Token
                    if (board[y][x]) {
                        cell.innerHTML = `<span class="token">${board[y][x]}</span>`;
                    }
                    cell.onclick = () => {
                        if (
                            selectedToken &&
                            players[myPlayerIdx]?.tokens > 0 &&
                            !board[y][x] &&
                            myPlayerIdx === currentPlayerIdx
                        ) {
                            socket.emit('placeToken', {
                                roomId: myRoomId,
                                x, y,
                                tokenType: selectedToken.symbol,
                                playerIdx: myPlayerIdx
                            });
                        }
                    };
                    boardGrid.appendChild(cell);
                }
            }
        }

        function renderTokenTray() {
            const tray = document.getElementById('token-tray');
            tray.innerHTML = '';
            tokenTypes.forEach((token, idx) => {
                const tokenDiv = document.createElement('div');
                tokenDiv.className = 'token-piece' + (selectedToken === token ? ' selected' : '');
                tokenDiv.textContent = token.symbol;
                tokenDiv.onclick = () => {
                    selectedToken = token;
                    renderTokenTray();
                };
                tray.appendChild(tokenDiv);
            });
        }

        // Socket.IO event handlers
        socket.on('gameStarted', ({ board: newBoard, playersState, currentTurn }) => {
            board = newBoard;
            players = playersState;
            currentPlayerIdx = currentTurn;
            const myName = localStorage.getItem('username');
            myPlayerIdx = players.findIndex(p => p.name === myName);
            renderPlayerCardsVertical();
            renderBoard();
            renderTokenTray();
        });

        socket.on('gameUpdate', ({ board: newBoard, playersState, currentTurn }) => {
            board = newBoard;
            players = playersState;
            currentPlayerIdx = currentTurn;
            renderPlayerCardsVertical();
            renderBoard();
            renderTokenTray();
        });

        // Start cinematic on load
        nextCinematic();
    </script>
</body>
</html> 