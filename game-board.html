<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Play&Boom - Game Board</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body {
      background: #000;
      color: #fff;
      margin: 0;
      height: 100vh;
      overflow: hidden;
    }
    .game-board {
      width: 100vw;
      height: 100vh;
      position: relative;
      display: flex;
      flex-direction: row;
    }
    .game-content-container {
      flex: 1;
      height: 100vh;
      background: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .player-list-vertical {
      width: 220px;
      height: 100vh;
      background: rgba(30, 30, 30, 0.95);
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 32px 0;
      z-index: 2;
      flex-shrink: 0;
    }
    .player-card-vertical {
      background: #34495e;
      margin: 12px 16px;
      padding: 18px 10px;
      border-radius: 8px;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .player-card-vertical.host {
      border: 2px solid #e74c3c;
    }
    .player-card-vertical .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #222;
    }
    .main-board-area {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      flex: 1;
      height: 100vh;
      gap: 64px;
    }
    #board-grid {
      display: grid;
      grid-template-columns: repeat(7, 80px);
      grid-template-rows: repeat(7, 80px);
      gap: 8px;
      background: #bbb;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 0 32px #000a;
    }
    .grid-cell {
      width: 80px;
      height: 80px;
      background: #eee;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.8rem;
      cursor: pointer;
      position: relative;
    }
    .grid-cell.center {
      background: #3af !important;
    }
    .grid-cell.corner {
      background: #eee !important;
      border: 2px solid #888;
    }
    .grid-cell .token {
      font-size: 2.5rem;
      color: #111;
    }
    #token-tray {
      display: flex;
      flex-direction: column;
      gap: 24px;
      /* background: #bbb; */
      background: red;
      padding: 32px 16px;
      border-radius: 12px;
      min-width: 96px;
      align-items: center;
      box-shadow: 0 0 16px #0005;
    }
    .token-piece {
      width: 72px;
      height: 72px;
      background: #fff;
      border: 2px solid #333;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 2.8rem;
      transition: background 0.2s, border 0.2s;
      color: #111;
    }
    .token-piece.selected {
      background: #3af;
      border: 2px solid #1a237e;
      color: #111;
    }
  </style>
</head>
<body>
  <div class="game-board">
    <div class="player-list-vertical" id="player-list-vertical"></div>
    <div class="game-content-container" id="game-content-container">
      <div class="main-board-area">
        <div id="board-grid"></div>
        <div id="token-tray"></div>
      </div>
    </div>
  </div>

  <script>
    const SERVER_URL = window.location.hostname === 'localhost'
      ? 'http://localhost:3000'
      : 'https://cs247.onrender.com';
    const socket = io(SERVER_URL);

    const N = 7;
    let board = Array.from({ length: N }, () => Array(N).fill(null));
    let players = [];
    let currentPlayerIdx = 0;
    let myPlayerIdx = null;
    let myRoomId = localStorage.getItem('roomPassword');
    let selectedToken = null;

    const tokenTypes = [
      { type: 'corner', symbol: '└' },
      { type: 'corner', symbol: '┘' },
      { type: 'corner', symbol: '┐' },
      { type: 'corner', symbol: '┌' },
      { type: 'straight', symbol: '│' },
      { type: 'straight', symbol: '─' },
      { type: 'cross', symbol: '┼' }
    ];
    
    // Convert rankings to tile counts
    // 3 -> 3 tiles, 2 -> 2 tiles, 1 -> 1 tile, 0 -> 0 tiles
    function getTileCountsFromRankings(rankings) { 
    const rankToTiles = [3, 2, 1, 0];
    return rankings.map(rank => rankToTiles[rank]);
}

    function renderPlayerCardsVertical() {
      const playerListVertical = document.getElementById('player-list-vertical');
      playerListVertical.innerHTML = '';
      let displayPlayers = players.filter(Boolean);
      if (!displayPlayers || displayPlayers.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.style.textAlign = 'center';
        emptyState.style.padding = '20px';
        emptyState.style.color = '#666';
        emptyState.textContent = 'Waiting for players...';
        playerListVertical.appendChild(emptyState);
        return;
      }
      displayPlayers.forEach((player, idx) => {
        const playerCard = document.createElement('div');
        playerCard.className = `player-card-vertical${player.alive ? '' : ' eliminated'}`;
        playerCard.style.background = player.color + 'cc';
        playerCard.style.display = 'flex';
        playerCard.style.alignItems = 'center';
        playerCard.style.gap = '16px';
        playerCard.style.padding = '16px';
        playerCard.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;gap:8px;width:100%;">
            <img src="${player.avatar}" alt="Avatar" class="avatar" style="width:64px;height:64px;border-radius:50%;background:#fff;object-fit:cover;box-shadow:0 0 8px #0007;">
            <div style="color:#fff;text-align:center;width:100%;">
              <div class="player-name" style="font-weight:bold;font-size:1.2em;margin-bottom:4px;">${player.name}${idx === currentPlayerIdx ? ' <span style=\'font-weight:bold\'>(Turn)</span>' : ''}</div>
              <div class="player-status" style="font-size:0.9em;opacity:0.8;">${player.alive ? 'Alive' : 'Eliminated'}</div>
              <div class="player-tokens" style="font-size:0.9em;opacity:0.8;">Tokens: ${player.tokens}</div>
            </div>
          </div>
        `;
        playerListVertical.appendChild(playerCard);
      });
    }

    function renderBoard() {
      const boardGrid = document.getElementById('board-grid');
      boardGrid.innerHTML = '';
      let displayPlayers = players.filter(Boolean);
      const cornerPositions = [
        [0, 0], [0, N - 1], [N - 1, N - 1], [N - 1, 0]
      ];
      let playerCornerMap = {};
      for (let i = 0; i < displayPlayers.length && i <= 4; i++) {
        const [y, x] = cornerPositions[i];
        playerCornerMap[`${y},${x}`] = displayPlayers[i];
      }
      for (let y = 0; y < N; y++) {
        for (let x = 0; x < N; x++) {
          const cell = document.createElement('div');
          cell.className = 'grid-cell';
          if ((y === 0 && x === 0) || (y === 0 && x === N - 1) || (y === N - 1 && x === N - 1) || (y === N - 1 && x === 0)) {
            cell.classList.add('corner');
            const player = playerCornerMap[`${y},${x}`];
            if (player) {
              cell.style.background = player.color + '33';
              cell.style.border = `2px solid ${player.color}`;
              cell.innerHTML = `<span class="token" style="color:${player.color};">L</span>`;
              board[y][x] = 'L';
            }
          }
          if (x === Math.floor(N / 2) && y === Math.floor(N / 2)) {
            cell.classList.add('center');
          }
          if (board[y][x] && !cell.innerHTML) {
            cell.innerHTML = `<span class="token">${board[y][x]}</span>`;
          }
          cell.onclick = () => {
          if (
            selectedToken &&
            players[myPlayerIdx]?.tilesLeft > 0 && // MODIFIED
            myPlayerIdx === currentPlayerIdx &&
            !((y === 0 && x === 0) || (y === 0 && x === N - 1) || (y === N - 1 && x === 0) || (y === N - 1 && x === N - 1)) &&
            !board[y][x]
          ) {
            board[y][x] = selectedToken.symbol;
            players[myPlayerIdx].tilesLeft--; // MODIFIED
            renderBoard();
            renderPlayerCardsVertical();
            renderTokenTray();
            socket.emit('placeToken', {
              roomId: myRoomId,
              x, y,
              tokenType: selectedToken.symbol,
              playerIdx: myPlayerIdx
            });
          }
        };
        boardGrid.appendChild(cell);
        }
      }
    }

    function renderTokenTray() {
      const tray = document.getElementById('token-tray');
      tray.innerHTML = '';
      tokenTypes.forEach((token) => {
        const tokenDiv = document.createElement('div');
        tokenDiv.className = 'token-piece' + (selectedToken === token ? ' selected' : '');
        tokenDiv.textContent = token.symbol;
        tokenDiv.onclick = () => {
          selectedToken = token;
          renderTokenTray();
        };
        tray.appendChild(tokenDiv);
      });
    }

    socket.on('gameStarted', ({ board: newBoard, players: ps, currentTurn }) => {
      const colors = ['#e74c3c', '#8e44ad', '#27ae60', '#f1c40f'];
      players = ps.map((player, idx) => ({
        ...typeof player === 'string'
          ? { name: player, color: colors[idx % 4], avatar: 'avatar1.png', tokens: 5, alive: true }
          : { ...player, color: player.color || colors[idx % 4] }
      }));
      currentPlayerIdx = currentTurn;
      myPlayerIdx = players.findIndex(p => p.name === localStorage.getItem('username'));
      renderPlayerCardsVertical();
      renderBoard();
      renderTokenTray();
    });

    socket.on('rankingsReady', ({ rankings }) => { // ⭐ NEW
    const tileCounts = getTileCountsFromRankings(rankings);
    for (let i = 0; i < players.length; i++) {
      players[i].tilesLeft = tileCounts[i];
    }
    renderPlayerCardsVertical();
  });

    socket.on('gameUpdate', ({ board: newBoard, players: ps, currentTurn }) => {
      const colors = ['#e74c3c', '#8e44ad', '#27ae60', '#f1c40f'];
      players = ps.map((player, idx) => ({
        ...typeof player === 'string'
          ? { name: player, color: colors[idx % 4], avatar: 'avatar1.png', tokens: 5, alive: true }
          : { ...player, color: player.color || colors[idx % 4] }
      }));
      currentPlayerIdx = currentTurn;
      renderPlayerCardsVertical();
      renderBoard();
      renderTokenTray();
    });

    async function fetchPlayersForRoom() {
      const roomId = localStorage.getItem('roomPassword');
      if (!roomId) return;
      try {
        const res = await fetch(`${SERVER_URL.replace('ws', 'http')}/api/rooms/${roomId}`);
        if (!res.ok) return;
        const data = await res.json();
        if (Array.isArray(data.players)) {
          const colors = ['#e74c3c', '#8e44ad', '#27ae60', '#f1c40f'];
          players = data.players.map((player, idx) => ({
            ...typeof player === 'string'
              ? { name: player, color: colors[idx % 4], avatar: 'avatar1.png', tokens: 5, alive: true }
              : { ...player, color: player.color || colors[idx % 4] }
          }));
          renderPlayerCardsVertical();
          renderBoard();
          renderTokenTray();
        }
      } catch (e) {
        console.error(e);
      }
    }

    fetchPlayersForRoom(); // Start game board immediately
    
    window.addEventListener('load', () => { // ⭐ TEMP TEST
    players = [
      { name: 'Alice', avatar: 'avatar1.png', color: '#e74c3c', tokens: 5, alive: true },
      { name: 'Bob', avatar: 'avatar1.png', color: '#8e44ad', tokens: 5, alive: true }
    ];
    currentPlayerIdx = 0;
    myPlayerIdx = 0;
    renderPlayerCardsVertical();
    renderBoard();
    renderTokenTray();

    // Simulate server sending rankings
    setTimeout(() => {
      socket.emit('rankingsReady', { rankings: [0, 2] });
      // You can also test this via: socket.emit('rankingsReady', { rankings: [1, 0] });
    }, 1000);
  });
  </script>
</body>
</html>
